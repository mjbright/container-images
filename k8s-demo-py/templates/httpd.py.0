#!/usr/bin/env python3

from http.server import BaseHTTPRequestHandler, HTTPServer
import socket

# from threading import Timer
import time, os, sys
import threading
import traceback

serverhost=socket.gethostname()
serverip=socket.gethostbyname(socket.gethostname())

hostName   = "0.0.0.0"
serverPort = 8080

ASCIITEXT="static/img/kubernetes_blue.txt"
PNG="static/img/kubernetes_blue.png"
IMAGE='UNSET'
HOSTTYPE='UNSET'

CONFIG={}

STARTED=False
LIVE=False
READY=False

def gettimestr():
    #d.strftime("%d/%m/%y")     => '11/03/02'
    #d.strftime("%A %d. %B %Y") => 'Monday 11. March 2002'
    # 2024-April-13 14:46:48
    return time.strftime('%Y-%B-%d %02H:%02M:%0S')

def thread(delay):
  global STARTED, LIVE, READY, CONFIG, START_TIME

  while True:
    time.sleep(1)
    # sys.stdout.write(".")
    delay = time.time() - START_TIME
    now=gettimestr()

    if not STARTED and "startup-delay" in CONFIG and delay > CONFIG["startup-delay"]:
        print(f"[{now}] Startup phase completed")
        STARTED=True
    if not LIVE and "liveness-delay" in CONFIG and delay > (CONFIG['liveness-delay'] + CONFIG['startup-delay']):
        print(f"[{now}] Liveness phase completed")
        LIVE=True
    if not READY and "readiness-delay" in CONFIG and delay > (CONFIG['readiness-delay'] + CONFIG['startup-delay']):
        print(f"[{now}] Readiness phase completed")
        READY=True


def readfile(path):
   return "".join( open(path).readlines() )

def readfile_lines(path):
   return open(path).readlines()

def read_config(config_file):
    config_lines = readfile_lines(config_file)
    config       = {}

    print(f"Reading config from {config_file}")

    keys=["startup-delay", "liveness-delay", "readiness-delay"]
    set_default_keys=["startup-delay", "liveness-delay", "readiness-delay"]

    for line in config_lines:
        for key in keys:
            if line.find(f"{key}:") == 0:
                #print(f"line={line}")
                pos = line.find(":")
                value = line[ line.find(":")+1 : ].lstrip().rstrip()
                if "delay" in key:
                    config[key]=int(value)
                else:
                    config[key]=value
                print(f'Setting config[{key}]="{value}"')

    for key in set_default_keys:
        if not key in config: config[key]=0

    print(f"config={config}")
    return config

class WebServer(BaseHTTPRequestHandler):

    def do_GET(self):
        global CONFIG, START_TIME

        print(CONFIG)

        host = self.headers.get('Host')
        useragent = self.headers.get('User-Agent').lower()

        # http return codes: https://www.rfc-editor.org/rfc/rfc7231#section-6.6

        now_secs=time.time()
        now=gettimestr()
        #print(f'[{now}] {IMAGE}: Request received for {host}{self.path} from user agent {useragent}\n')
        #sys.stderr.write(f'[{now}] [{hosttype} {networkinfo}] {IMAGE}: Request received for {host}{self.path} from user agent {useragent}\n')

        if self.path == "/status":
            self.send_response(200)
            self.send_header("Content-type", "text/html")
            self.end_headers()
            self.wfile.write(bytes(f"Time since start={ now_secs - START_TIME } secs\n", "utf8"))

            self.wfile.write(bytes(f"CONFIG={CONFIG}\n", "utf8"))
            self.wfile.write(bytes(f"STARTED={STARTED} LIVE={LIVE} READY={READY}\n", "utf8"))
            return

        if self.path == "/startz":
            self.wfile.write(bytes("OK", "utf8"))
            if 'startup-delay' in CONFIG and secs > CONFIG['startup-delay']:
                self.send_response(200)
                self.send_header("Content-type", "text/html")
                self.end_headers()
                self.wfile.write(bytes("OK", "utf8"))
            else:
                self.send_response(503)
                self.send_header("Content-type", "text/html")
                self.end_headers()
                self.wfile.write(bytes("NOT Started", "utf8"))
                #self.send_error(500,traceback.format_exc())
            return

        if self.path == "/healthz":
            if 'liveness-delay' in CONFIG and LIVE:
                self.send_response(200)
                self.send_header("Content-type", "text/html")
                self.end_headers()
                self.wfile.write(bytes("OK", "utf8"))
            else:
                self.send_response(503)
                self.send_header("Content-type", "text/html")
                self.end_headers()
                self.wfile.write(bytes("NOT Healthy", "utf8"))
                #self.send_error(500,traceback.format_exc())
            return

        if self.path == "/readyz":
            secs = START_TIME - time.time()
            if 'readiness-delay' in CONFIG and READY:
                self.send_response(200)
                self.send_header("Content-type", "text/html")
                self.end_headers()
                self.wfile.write(bytes("OK", "utf8"))
            else:
                self.send_response(503)
                self.send_header("Content-type", "text/html")
                self.end_headers()
                self.wfile.write(bytes("NOT Ready", "utf8"))
                #self.send_error(500,traceback.format_exc())
            return

        if not READY:
            self.send_response(503)
            self.send_header("Content-type", "text/html")
            self.end_headers()
            self.wfile.write(bytes("NOT Ready", "utf8"))
            return

        hosttype=HOSTTYPE
        imageinfo=IMAGE
        networkinfo=f"{serverhost}/{serverip}"

        self.send_response(200)
        self.send_header("Content-type", "text/html")
        self.end_headers()

        sys.stderr.write(f'[{now}] [{networkinfo}] {IMAGE}: Request received for {host}{self.path} from user agent {useragent}\n')

        content=""
        if "curl" in useragent or "http" in useragent or "wget" in useragent:
            if self.path != "/1":
                if os.path.isfile(ASCIITEXT):
                    content = readfile(ASCIITEXT)
                else:
                    content = f'[wd={ os.getcwd() }] No such file as { ASCIITEXT } - '
            content+=f"[{hosttype} {networkinfo}] {imageinfo} - Request from { host }\n"
        else:
            template_values = {
                'host': host,
                'PNG':  PNG,
                'hosttype': hosttype,
                'imageinfo': imageinfo,
                'networkinfo': networkinfo,
            }
            if os.path.isfile(PNG):
                content = readfile("templates/index.html.tmpl").format(**template_values)
            else:
                content = f'''
<html><head><title>Error</title></head>
<body>
    <p>[wd={ os.getcwd() }] No such file as { ASCIITEXT }</p>
</body></html>
'''

        self.wfile.write(bytes(content, "utf8"))


if __name__ == "__main__":        
    START_TIME=time.time()

    # NOTE: use of , in args, even when a single value:
    threading.Thread(target=thread, args=(1.0,)).start()

    # In container:
    if os.path.exists("/etc/k8s-demo/config"):
        CONFIG=read_config("/etc/k8s-demo/config")
    
    # TESTING: If not in container:
    if os.path.exists("examples/etc/k8s-demo/config"):
        CONFIG=read_config("examples/etc/k8s-demo/config")
    
    webServer = HTTPServer((hostName, serverPort), WebServer)
    now=gettimestr()
    sys.stderr.write(f"[{now}] [{serverhost}/{serverip}] [wd={ os.getcwd() }]: Server started - listening on http://{hostName}:{serverPort}\n")

    try:
        webServer.serve_forever()
    except KeyboardInterrupt:
        pass

    webServer.server_close()

